# Supabase ì—°ë™ ì™„ë£Œ ìš”ì•½

## ğŸ¯ êµ¬í˜„ ê°œìš”

SportComm í”„ë¡œì íŠ¸ì— Supabase ì—°ë™ì„ ì„±ê³µì ìœ¼ë¡œ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. ë¡œì»¬ PostgreSQL DBëŠ” ì£¼ìš” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹í•˜ê³ , SupabaseëŠ” ì±„íŒ… ë° ì‹¤ì‹œê°„ ê¸°ëŠ¥ì„ ì „ë‹´í•˜ëŠ” í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜ë¥¼ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.

## ğŸ“‹ êµ¬í˜„ëœ ê¸°ëŠ¥

### 1. ë°±ì—”ë“œ (NestJS) ë³€ê²½ì‚¬í•­

#### ğŸ”§ ì‚¬ìš©ì ì—”í‹°í‹° í™•ì¥

- `User` ì—”í‹°í‹°ì— `supabaseUserId` í•„ë“œ ì¶”ê°€
- Supabaseì™€ ë¡œì»¬ DB ê°„ ì‚¬ìš©ì ì‹ë³„ì ì—°ê²°

#### ğŸ”„ ë™ê¸°í™” ì„œë¹„ìŠ¤ êµ¬í˜„

- `SupabaseSyncService`: ì‚¬ìš©ì ì •ë³´ ì–‘ë°©í–¥ ë™ê¸°í™”
- íšŒì›ê°€ì… ì‹œ ìë™ Supabase ì‚¬ìš©ì ìƒì„±
- í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹œ ì‹¤ì‹œê°„ ë™ê¸°í™”
- ê³„ì • ë¹„í™œì„±í™” ì‹œ Supabase ë°˜ì˜

#### ğŸ› ï¸ ì¸ì¦ ì„œë¹„ìŠ¤ í™•ì¥

- `AuthService`ì— Supabase ì—°ë™ ë¡œì§ ì¶”ê°€
- ê¸°ì¡´ ì‚¬ìš©ì ë§ˆì´ê·¸ë ˆì´ì…˜ ê¸°ëŠ¥
- ë™ê¸°í™” í†µê³„ ë° ê´€ë¦¬ ê¸°ëŠ¥

#### ğŸ“Š ê´€ë¦¬ì ê¸°ëŠ¥

- `AuthAdminResolver`: ê´€ë¦¬ì ì „ìš© ë™ê¸°í™” ê´€ë¦¬
- ê°œë³„/ì „ì²´ ì‚¬ìš©ì ë™ê¸°í™”
- ë™ê¸°í™” ìƒíƒœ ëª¨ë‹ˆí„°ë§

#### ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

- `001_add_supabase_user_id.ts`: ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
- ì¸ë±ìŠ¤ ì¶”ê°€ë¡œ ì„±ëŠ¥ ìµœì í™”

### 2. Supabase ìŠ¤í‚¤ë§ˆ ì„¤ê³„

#### ğŸ“‹ í…Œì´ë¸” êµ¬ì¡°

```sql
- profiles: ì‚¬ìš©ì í”„ë¡œí•„ (ë¡œì»¬ DBì™€ ë™ê¸°í™”)
- chat_rooms: ì±„íŒ…ë°© ì •ë³´
- chat_room_members: ì±„íŒ…ë°© ì°¸ì—¬ì
- chat_messages: ì±„íŒ… ë©”ì‹œì§€
```

#### ğŸ” ë³´ì•ˆ ì„¤ì •

- Row Level Security (RLS) ì •ì±… ì ìš©
- ì±„íŒ…ë°© ì°¸ì—¬ìë§Œ ë©”ì‹œì§€ ì ‘ê·¼ ê°€ëŠ¥
- ì‹¤ì‹œê°„ ì•Œë¦¼ íŠ¸ë¦¬ê±° êµ¬í˜„

### 3. í”„ë¡ íŠ¸ì—”ë“œ (React Native) ì¤€ë¹„

#### ğŸ“± Supabase ì±„íŒ… í´ë¼ì´ì–¸íŠ¸

- `supabase-chat.ts`: ì±„íŒ… ì „ìš© í´ë¼ì´ì–¸íŠ¸
- AsyncStorageë¥¼ í†µí•œ ì„¸ì…˜ ê´€ë¦¬
- ì‹¤ì‹œê°„ ë©”ì‹œì§€ êµ¬ë… ê¸°ëŠ¥

#### ğŸ”§ í™˜ê²½ ì„¤ì •

- í™˜ê²½ ë³€ìˆ˜ í…œí”Œë¦¿ ì—…ë°ì´íŠ¸
- ì±„íŒ… ê¸°ëŠ¥ í™œì„±í™” í”Œë˜ê·¸

## ğŸš€ ì„¤ì • ë°©ë²•

### 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

**ë°±ì—”ë“œ (.env)**

```bash
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
SUPABASE_SYNC_ENABLED=true
SUPABASE_AUTO_SYNC=true
```

**í”„ë¡ íŠ¸ì—”ë“œ (.env)**

```bash
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
USE_SUPABASE_CHAT=true
USE_REALTIME=true
```

### 2. Supabase ì„¤ì •

1. Supabase í”„ë¡œì íŠ¸ ìƒì„±
2. `supabase-schema.sql` ì‹¤í–‰í•˜ì—¬ í…Œì´ë¸” ìƒì„±
3. RLS ì •ì±… ë° íŠ¸ë¦¬ê±° ìë™ ì„¤ì •

### 3. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

```bash
cd apps/be
npm run typeorm:migration:run
```

## ğŸ“¡ í†µì‹  íë¦„

### ì‚¬ìš©ì ê´€ë¦¬

1. **íšŒì›ê°€ì…**: ë¡œì»¬ DB â†’ Supabase ìë™ ë™ê¸°í™”
2. **ë¡œê·¸ì¸**: ë¡œì»¬ DB ì¸ì¦ â†’ Supabase ì„¸ì…˜ ìƒì„±
3. **í”„ë¡œí•„ ìˆ˜ì •**: ë¡œì»¬ DB ì—…ë°ì´íŠ¸ â†’ Supabase ì‹¤ì‹œê°„ ë°˜ì˜

### ì±„íŒ… ê¸°ëŠ¥

1. **ë©”ì‹œì§€ ì „ì†¡**: í”„ë¡ íŠ¸ì—”ë“œ â†’ Supabase ì§ì ‘ ì €ì¥
2. **ì‹¤ì‹œê°„ ìˆ˜ì‹ **: Supabase Realtime â†’ í”„ë¡ íŠ¸ì—”ë“œ êµ¬ë…
3. **ì‚¬ìš©ì ì •ë³´**: Supabase profiles í…Œì´ë¸”ì—ì„œ ì¡°íšŒ

## ğŸ” ì£¼ìš” íŠ¹ì§•

### âœ… ì¥ì 

- **ì´ì¤‘í™”**: ë¡œì»¬ DB ì¥ì•  ì‹œì—ë„ ì±„íŒ… ê¸°ëŠ¥ ìœ ì§€
- **ì‹¤ì‹œê°„**: Supabase Realtimeìœ¼ë¡œ ì¦‰ì‹œ ë©”ì‹œì§€ ì „ë‹¬
- **í™•ì¥ì„±**: ì±„íŒ… ê¸°ëŠ¥ ë…ë¦½ì  í™•ì¥ ê°€ëŠ¥
- **ì„±ëŠ¥**: ì±„íŒ… ë¶€í•˜ê°€ ë©”ì¸ DBì— ì˜í–¥ ì—†ìŒ

### âš ï¸ ì£¼ì˜ì‚¬í•­

- ì‚¬ìš©ì ì •ë³´ ë™ê¸°í™” ìƒíƒœ ëª¨ë‹ˆí„°ë§ í•„ìš”
- Supabase ìš”ê¸ˆì œì— ë”°ë¥¸ ì‚¬ìš©ëŸ‰ ê´€ë¦¬
- ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì‹œ ë™ê¸°í™” ì¬ì‹œë„ ë¡œì§ í•„ìš”

## ğŸ› ï¸ ê°œë°œ ë„êµ¬

### GraphQL ì¿¼ë¦¬ ì˜ˆì‹œ

```graphql
# ë™ê¸°í™” í†µê³„ ì¡°íšŒ
query {
  getSupabaseSyncStats {
    totalUsers
    syncedUsers
    unsyncedUsers
    supabaseConnected
  }
}

# ì‚¬ìš©ì ë™ê¸°í™”
mutation {
  syncUserWithSupabase(userId: "user-id")
}
```

### ì‹¤ì‹œê°„ ì±„íŒ… êµ¬ë…

```typescript
const unsubscribe = supabaseChatClient.subscribeToMessages(
  roomId,
  (message) => {
    console.log("ìƒˆ ë©”ì‹œì§€:", message);
  }
);
```

## ğŸ“š ë¬¸ì„œ ë° ê°€ì´ë“œ

- `README-SUPABASE-SETUP.md`: ìƒì„¸ ì„¤ì • ê°€ì´ë“œ
- `supabase-schema.sql`: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ
- `apps/fe/lib/supabase-chat.ts`: í”„ë¡ íŠ¸ì—”ë“œ í´ë¼ì´ì–¸íŠ¸

## ğŸ‰ ë‹¤ìŒ ë‹¨ê³„

1. **Supabase í”„ë¡œì íŠ¸ ìƒì„±** ë° í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
2. **ìŠ¤í‚¤ë§ˆ ì‹¤í–‰** ë° RLS ì •ì±… í™•ì¸
3. **ê¸°ì¡´ ì‚¬ìš©ì ë™ê¸°í™”** ì‹¤í–‰
4. **í”„ë¡ íŠ¸ì—”ë“œ ì±„íŒ… UI** êµ¬í˜„
5. **ì‹¤ì‹œê°„ ì•Œë¦¼** ê¸°ëŠ¥ ì¶”ê°€

## ğŸ“ ì§€ì›

êµ¬í˜„ ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒí•˜ë©´ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ìƒíƒœ
2. Supabase í”„ë¡œì íŠ¸ í™œì„±í™” ìƒíƒœ
3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ
4. ë¡œê·¸ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸

---

**ì»¤ë°‹ ë©”ì‹œì§€**: `feat: Supabase ì—°ë™ìœ¼ë¡œ ì±„íŒ… ë° ì‹¤ì‹œê°„ ê¸°ëŠ¥ êµ¬í˜„`

## ğŸ”— ìƒˆë¡œìš´ í†µì‹  íë¦„ (ì—…ë°ì´íŠ¸ë¨)

### ì¸ì¦ íë¦„

1. **FE**: ì‚¬ìš©ìê°€ ë¡œê·¸ì¸/íšŒì›ê°€ì… ìš”ì²­ â†’ NestJS GraphQL API
2. **BE**: ë¡œì»¬ DBì—ì„œ ì‚¬ìš©ì ì¸ì¦ â†’ Supabaseì— ì‚¬ìš©ì ë™ê¸°í™” â†’ ë‘ í† í° ë°˜í™˜
   - NestJS JWT (ì£¼ìš” API ì¸ì¦ìš©)
   - Supabase Session (ì±„íŒ…/ì‹¤ì‹œê°„ ê¸°ëŠ¥ìš©)
3. **FE**: ë‘ í† í° ëª¨ë‘ ì €ì¥ â†’ Supabase ì±„íŒ… í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”

### ê¸°ëŠ¥ë³„ í†µì‹  íë¦„

- **ê²Œì‹œê¸€, ëŒ“ê¸€, íŒ”ë¡œìš° ë“±**: FE â†’ NestJS API â†’ ë¡œì»¬ PostgreSQL
- **ì±„íŒ… ë©”ì‹œì§€**: FE â†’ Supabase Realtime â†’ chat_messages í…Œì´ë¸”
- **ì‹¤ì‹œê°„ ì•Œë¦¼**: Supabase Realtime êµ¬ë…
- **ì‚¬ìš©ì í”„ë¡œí•„ ë™ê¸°í™”**: NestJS â†’ ë¡œì»¬ DB + Supabase profiles í…Œì´ë¸”

### ğŸ“Œ êµ¬í˜„ëœ ì£¼ìš” íŠ¹ì§•

#### âœ… ì´ì¤‘ ì¸ì¦ ì‹œìŠ¤í…œ

- **NestJS JWT**: ì£¼ìš” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ API ì¸ì¦
- **Supabase Session**: ì±„íŒ… ë° ì‹¤ì‹œê°„ ê¸°ëŠ¥ ì „ìš©

#### âœ… ìë™ ì‚¬ìš©ì ë™ê¸°í™”

- íšŒì›ê°€ì…/ë¡œê·¸ì¸ ì‹œ Supabaseì— ìë™ ë™ê¸°í™”
- í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹œ ì–‘ë°©í–¥ ë™ê¸°í™”
- ê¸°ì¡´ ì‚¬ìš©ì ë§ˆì´ê·¸ë ˆì´ì…˜ ì§€ì›

#### âœ… ì„¸ì…˜ ê´€ë¦¬

- ì•± ì‹œì‘ ì‹œ ì €ì¥ëœ ì„¸ì…˜ ìë™ ë³µì›
- Supabase í† í° ë§Œë£Œ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨
- ë¡œê·¸ì•„ì›ƒ ì‹œ ëª¨ë“  ì„¸ì…˜ ì •ë¦¬

#### âœ… ì±„íŒ… ê¸°ëŠ¥ ë¶„ë¦¬

- ì±„íŒ… ì‹¤íŒ¨ ì‹œì—ë„ ë©”ì¸ ê¸°ëŠ¥ ì •ìƒ ë™ì‘
- ë…ë¦½ì ì¸ ì±„íŒ… í´ë¼ì´ì–¸íŠ¸ ê´€ë¦¬
- ì‹¤ì‹œê°„ ë©”ì‹œì§€ êµ¬ë…/ë°œì†¡

## ğŸš€ ì‚¬ìš© ë°©ë²•

### 1. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¸ì¦ ì‚¬ìš©

```typescript
// AuthForm.tsxì—ì„œ ì´ë¯¸ êµ¬í˜„ë¨
import { useAuth } from '../hooks/useAuth';

const MyComponent = () => {
  const { isAuthenticated, user, hasChatAccess, login, logout } = useAuth();

  if (!isAuthenticated) {
    return <AuthForm onLoginSuccess={login} />;
  }

  return (
    <View>
      <Text>í™˜ì˜í•©ë‹ˆë‹¤, {user?.nickname}ë‹˜!</Text>
      {hasChatAccess ? (
        <Text>ì±„íŒ… ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥</Text>
      ) : (
        <Text>ì±„íŒ… ê¸°ëŠ¥ ì‚¬ìš© ë¶ˆê°€</Text>
      )}
    </View>
  );
};
```

### 2. ì±„íŒ… ê¸°ëŠ¥ ì‚¬ìš©

```typescript
import { supabaseChatClient } from "../lib/supabase-chat";

// ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ
const rooms = await supabaseChatClient.getChatRooms(userId);

// ë©”ì‹œì§€ ì „ì†¡
await supabaseChatClient.sendMessage(roomId, "ì•ˆë…•í•˜ì„¸ìš”!");

// ì‹¤ì‹œê°„ ë©”ì‹œì§€ êµ¬ë…
const unsubscribe = supabaseChatClient.subscribeToMessages(
  roomId,
  (message) => {
    console.log("ìƒˆ ë©”ì‹œì§€:", message);
  }
);
```

### 3. ê´€ë¦¬ì ê¸°ëŠ¥ (ë°±ì—”ë“œ)

```graphql
# ë™ê¸°í™” í†µê³„ ì¡°íšŒ
query {
  getSupabaseSyncStats {
    totalUsers
    syncedUsers
    unsyncedUsers
    supabaseConnected
  }
}

# ì‚¬ìš©ì ë™ê¸°í™”
mutation {
  syncUserWithSupabase(userId: "user-id")
}
```
